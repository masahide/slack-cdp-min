# ログブラウズ機能リアルタイム改修 TDD TODO

## 0. テスト基盤セットアップ

- [x] (RED) `apps/browser` のテスト環境で SSE/ポーリングを検証できるよう、`vitest` にファイル監視モックを追加する失敗テストを用意する
- [x] (GREEN) ファイル監視モックとテスト用ヘルパー (`createJsonlFixture`) を実装してテストを成功させる
- [x] (REFACTOR) 既存テストと共通化できるユーティリティを `tests/browser/utils.ts` に集約する

## 1. JSONL 追記の即時反映

- [x] (RED) `/day/[date]` のロード時に SSE 経由で新規イベントを待ち受ける E2E 風テストを追加し、未実装で失敗させる
- [x] (GREEN) ファイル追記を監視してサーバーからイベントをプッシュするエンドポイントを実装し、クライアントでストリーム反映してテストを通す
- [x] (REFACTOR) ポーリングフォールバック・エラーハンドリングを整理し、更新トーストの表示ロジックをコンポーネント化する

## 2. ダークモード対応

- [x] (RED) `prefers-color-scheme` と手動トグルの状態が SSR/CSR で同期する失敗テストを追加する
- [x] (GREEN) テーマストアと CSS 変数を導入し、ライト/ダークでコントラスト AA を満たすスタイルを実装してテストを成功させる
- [x] (REFACTOR) コンポーネントのカラートークンを `tokens.css` に集約し、既存ライトテーマとの差分を最小化する

## 3. メッセージ Markdown レンダリング

- [x] (RED) Slack テキストを Markdown としてレンダリングし、リンク/コード/引用が HTML に変換されるサーバーサイドテストを追加する
- [x] (GREEN) `markdown-it` などのレンダラとサニタイズレイヤーを組み込み、XSS を阻止しつつ表示を改善してテストを通す
- [x] (REFACTOR) レンダラ設定を再利用できるよう `lib/markdown.ts` に抽出し、既存サマリ表示も同設定で統一する

## 4. リアクション元メッセージプレビュー

- [x] (RED) リアクション行に対象メッセージの Markdown プレビューが表示されること、折りたたみ状態が保持されることを確認する失敗テストを追加する
- [x] (GREEN) リアクションイベントに紐づくメッセージを取得し Markdown 化したプレビューコンポーネントを実装してテストを成功させる
- [ ] (REFACTOR) プレビューコンポーネントをタイムライン共通部品として整理し、アクセシビリティ属性 (ARIA) を付与する

## 5. ドキュメント・検証更新

- [x] (RED) `docs/spec.md` の追加要件に対する未整備箇所を検出するチェック（例：Lint もしくはスナップショットテスト）を計画し TODO として失敗させる
- [x] (GREEN) README のブラウズ機能説明と QA 手順 (`pnpm run qa`) の更新を行い、必要なら自動チェックを実装してテストを通す
- [ ] (REFACTOR) 実装完了後のスクリーンショットや手動検証ログを `docs/` に追記し、将来の回帰テスト観点を整理する
