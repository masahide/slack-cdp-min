# 4.4 サマリ生成フロー & 編集 UI TDDタスクリスト

## 0. テスト基盤の整備

- [x] RED: `apps/browser` の Svelte コンポーネントを Vitest + `@testing-library/svelte` で検証できるセットアップを追加し、未完成のままテストが失敗することを確認する。
- [x] GREEN: テスト基盤が動作するように最小限の設定とダミーコンポーネントを実装する。
- [x] REFACTOR: テスト用ヘルパーとモック（サマリ JSONL 読み込み、LLM API スタブ）を共通化し、フィクスチャ生成関数を `tests/helpers` へ切り出す。

## 1. サマリ作成ボタン起点のフロー

- [x] RED: `/day/<date>` 画面で「サマリを作成」ボタン押下時にフェッチ呼び出し・既存サマリ読み込み・`?summary=edit` 復元が起きることを検証する失敗テストを書く。
- [x] GREEN: ボタンを実装し、既存サマリの存在チェックと新規生成要求（4.1 パイプライン呼び出し）、URL パラメータによる再編集導線の再現までを通す。
- [x] REFACTOR: 日付別データアクセスをサービス層に抽出し、テストでファイルシステム依存を外しつつ再編集パラメータ処理を共通化する。

## 2. 3ペインレイアウトの骨組み

- [x] RED: LLMチャット／編集／プレビューの 3 ペインが初期レンダリングされることを検証するスナップショットまたはロールテストを作成し、未実装で失敗させる。
- [x] GREEN: 3 カラムレイアウトを Svelte コンポーネントで実装し、スタブデータで各ペインが描画されるようにする。
- [x] REFACTOR: レイアウトスタイルを共通 CSS モジュールへ移し、レスポンシブ要件をユニットテストから独立した Storybook/Playwright のビジュアル回帰準備に繋げる。

## 3. 編集ウィンドウ

- [x] RED: Markdown 編集テキストエリアが `Cmd/Ctrl+S` と `Cmd/Ctrl+Enter` のショートカットを発火し、500ms デバウンスでストア更新することを検証する失敗テストを書く。
- [x] GREEN: 実装を追加し、ショートカット時のイベント発火とストア同期がテストで通るようにする。
- [x] REFACTOR: 入力ハンドラをカスタムフックへ分離し、他コンポーネントからも再利用できるようにする。

## 4. LLM チャットウィンドウ機能

- [x] RED: モデル選択・テキスト選択送信・差分プレビューの挙動をモック API で検証する失敗テストを書く（編集ストアを前提にする）。
- [x] GREEN: モデル一覧を `reaclog.config.json` から読み込むストアと、モック API を使った差分表示ロジックを実装する。
- [x] REFACTOR: 差分適用処理を純関数化し、ユニットテストで置き換え／追記／キャンセルの分岐網羅を行う。

## 5. プレビューウィンドウ

- [x] RED: 編集ストアの更新に応じて 300–500ms デバウンスで HTML が再レンダリングされることを確認する失敗テストを追加する。
- [x] GREEN: `marked` 等を用いた Markdown → HTML 変換とスクロール同期の最小実装を行う。
- [x] REFACTOR: レンダリングパイプラインをワーカー化する準備として、変換処理を別モジュールへ抽出し副作用を局所化する。

## 6. 保存と下書き管理

- [x] RED: 保存アクションが `<dataDir>/YYYY/MM/DD/summaries/daily.md` への書き出しとトースト通知、離脱前の確認ダイアログ、保存失敗時のエラー通知を検証する失敗テストを書く。
- [x] GREEN: ファイル永続化 API（モック）とトースト表示、離脱ガード、保存完了後の自動再読込（再描画）を実装しテストを通す。
- [x] REFACTOR: 保存結果のタイムスタンプ表示とエラー処理をストアに保持し、再利用しやすいフォーマット関数・共通エラーハンドラへ集約する。

## 7. 回帰テストとリグレッション防止

- [x] RED: 主要ユーザーフロー（サマリ読込→編集→LLM 助言→保存）とサマリ初期生成失敗時のエラー通知を Playwright などで記述し、現状は失敗することを確認する。
- [x] GREEN: 実装完了後に E2E シナリオが成功し、CI へ組み込む。
- [x] REFACTOR: テストデータのリセットとモック API のライフサイクル管理を共通ユーティリティにまとめ、将来の機能追加時にテスト拡張しやすくする。

## 8. Structured Output 対応サマリ提案 API

- [ ] RED: `/api/summary/suggestion` のサーバーテストを追加し、リクエスト body／OpenAI リクエスト payload／レスポンス JSON が `summary_update` と `assistant_message` を含むこと、エラー時は 4xx/5xx を返すことを検証して失敗させる。
- [ ] GREEN: `apps/browser/src/routes/api/summary/suggestion/+server.ts` を実装し、OpenAI Responses API へ Structured Output Schema 付きでリクエスト、モックを使ってテストを通す。
- [ ] REFACTOR: スキーマ定義・OpenAI 呼び出しラッパー・エラーハンドリングをユーティリティへ切り出し、型定義を共有化する。

- [ ] RED: `SummaryWorkspace` のコンポーネントテストで、API 応答の `summary_update` に応じて本文を置換／追記し、`assistant_message` を別領域に表示する振る舞いを追加して失敗させる。
- [ ] GREEN: `requestSuggestion` クライアントを更新し、新フォーマットをパースしてエディタ内容と提案ログを反映する実装を通す。
- [ ] REFACTOR: 差分適用ロジックを純関数化し、`mode: replace/append/none` の分岐をユニットテストで網羅する。

- [ ] RED: `SummaryRegression.e2e.test.ts` に構造化応答を返すモックを追加し、LLM メッセージ表示とサマリ更新を確認するシナリオを先に失敗させる。
- [ ] GREEN: ルート・クライアント両対応後に E2E を通し、既存フロー回帰も確認する。
- [ ] REFACTOR: テスト用 OpenAI モックを共通化し、API キー欠如や OpenAI 側 422 応答など例外パスも追加入力できるようヘルパーを整理する。
